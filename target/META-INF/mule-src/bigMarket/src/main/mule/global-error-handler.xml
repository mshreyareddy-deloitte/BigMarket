<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd">
	<error-handler name="global-error-handler" doc:id="4f3b124c-444c-4537-88af-c1c166b2272f" >
	<on-error-propagate type="APIKIT:BAD_REQUEST" enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="385f35e2-6c81-48b6-8351-16b260be7fb2" >
			<set-variable value="#[400]" doc:name="Set HTTP Status - 400" doc:id="98c0b248-78fe-4155-b8ef-3a2c2cd6af11" variableName="httpStatus"/>
			<set-variable value='Bad request' doc:name="set Error Message" doc:id="e6ddf045-70a8-4a74-b444-dccec6809ff2" variableName="errorMessage"/>
			<set-variable value='#[(((error.description default "" replace "[" with "") replace "]" with "") splitBy "\n")]' doc:name="Set Error Description" doc:id="155af258-234d-4fad-8874-7857b9f3ef93" variableName="errorDescription"/>
			<flow-ref doc:name="global-prepare-error-response-sub-flow" doc:id="36aaf205-1f8c-46c6-8481-c08b929171b3" name="global-prepare-error-response-sub-flow"/>
		</on-error-propagate> 
		<on-error-propagate type="APIKIT:METHOD_NOT_ALLOWED" enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="3553c338-3a3f-45ce-9557-abc8de39784e" >
			<set-variable value="#[405]" doc:name="Set HTTP Status - 405" doc:id="b759b6c4-23f4-4b22-b67c-93cb3f68f11d" variableName="httpStatus" />
			<set-variable value='Method Not Allowed' doc:name="Set Error Message" doc:id="dab2ccb3-72fd-4656-9e13-f54588a4d2fb" variableName="errorMessage"/>
			<set-variable value="The method specified in the request is not allowed for this resource" doc:name="Set Error Description" doc:id="1ab9d7aa-43ef-4959-aef3-2fedac2082ae" variableName="errorDescription"/>
			<flow-ref doc:name="global-prepare-error-response-sub-flow" doc:id="38be5335-4c3f-47ec-917d-1d42384e056d" name="global-prepare-error-response-sub-flow"/>
		</on-error-propagate>
		<on-error-propagate type="APIKIT:NOT_ACCEPTABLE" enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="f6f4fc67-4c3c-46d8-917d-49f231358438" >
			<set-variable value="#[406]" doc:name="Set HTTP Status - 406" doc:id="195532a0-4c25-4dac-b51e-214b24f8be1d" variableName="httpStatus" />
      <set-variable value="Not Acceptable" doc:name="Set Error Message" doc:id="25ba47a7-277b-442f-8a87-1b1c836ef1e5" variableName="errorMessage"/>
			<set-variable value="The resource identified by the request is not capable of generating response entities according to the request accept headers" doc:name="Set Error Description" doc:id="2f930869-d066-4eff-9a33-fbe345219eed" variableName="errorDescription"/>
			<flow-ref doc:name="global-prepare-error-response-sub-flow" doc:id="a2670e87-a5dc-4f45-837e-e6fbefca8718" name="global-prepare-error-response-sub-flow"/>
		</on-error-propagate>
		<on-error-propagate type="APIKIT:NOT_FOUND" enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="c099b8ec-9166-425c-9850-72251c65dafa" >
			<set-variable value="#[404]" doc:name="Set HTTP Status - 404" doc:id="e7ebd23f-4971-4550-85a2-a74fe52b66d0" variableName="httpStatus" />
			<set-variable value="Not found" doc:name="Set Error Message" doc:id="160db5db-50f5-4933-9db5-d8fca4bed9aa" variableName="errorMessage"/>
			<set-variable value="The server has not found anything matching the Request-URI" doc:name="Set Error Description" doc:id="26ae3450-9d9c-46f0-81f4-77df0a8bd03f" variableName="errorDescription"/>
			<flow-ref doc:name="global-prepare-error-response-sub-flow" doc:id="01decff9-0ff6-46f0-a80c-773879c805d5" name="global-prepare-error-response-sub-flow"/>
		</on-error-propagate>
		<on-error-propagate type="APIKIT:UNSUPPORTED_MEDIA_TYPE" enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="96b7d01d-5bdb-495b-a845-37d177945375" >
			<set-variable value="#[415]" doc:name="Set HTTP Status - 415" doc:id="e4dd22e7-6439-4ac1-9da4-4d1ca438712a" variableName="httpStatus" />
      <set-variable value="Unsupported media type" doc:name="Set Error Message" doc:id="71b374c0-3baa-44b4-b0fa-1255568c3c8e" variableName="errorMessage"/>
			<set-variable value="The server is refusing to service the request because the entity of the request is in a format not supported by the requested resource for the requested method" doc:name="Set Error Description" doc:id="4071116b-7761-4d29-9e67-0a25215e6dea" variableName="errorDescription"/>
			<flow-ref doc:name="global-prepare-error-response-sub-flow" doc:id="48301ccc-3e65-4c15-9f82-32d42c6ee394" name="global-prepare-error-response-sub-flow"/>
		</on-error-propagate>	
		
		<!-- DB Related issues -->
		
		<!-- HTTP Requster Related error handling -->	
		<on-error-propagate type="HTTP:BAD_REQUEST" enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="eebf0f5b-b122-4fa7-aaa0-aea4fb062a4d" >
			<set-variable value="#[400]" doc:name="Set HTTP Status - 400" doc:id="21e47edb-d274-4f28-8970-76a740266188" variableName="httpStatus" />
      <set-payload value="#[error.muleMessage.payload]" doc:name="Set Payload" doc:id="c40cd269-6daf-4e46-a2ec-c9fada055f94" />
		</on-error-propagate>
		<on-error-propagate type="HTTP:CLIENT_SECURITY" enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="f66f5adf-0f7a-4a2e-ab3e-5076b50a065b" >
			<set-variable value="#[401]" doc:name="Set HTTP Status - 401" doc:id="553a9f82-e26f-49ab-a33b-b087a5f269a3" variableName="httpStatus" />
			<set-payload value="#[error.muleMessage.payload]" doc:name="Set Payload" doc:id="70b56e4a-f79e-4e22-ae3d-162b73b68dc5" />
		
</on-error-propagate>
		<on-error-propagate type="HTTP:CONNECTIVITY" enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="a700a3a4-22e6-4830-aea4-8ec9a90b54f1" >
			<set-variable value="#[503]" doc:name="Set HTTP Status - 503" doc:id="d2164746-4192-4259-acf1-560eee4366ce" variableName="httpStatus" />
      <set-variable value="Service unavailable" doc:name="Set Error Message" doc:id="4ab42e65-be71-411f-9379-592a3f313b9a" variableName="errorMessage" />
			<set-variable value="The (upstream) service is temporarily not available " doc:name="Set errorDescription" doc:id="ed99e0c7-5c4a-4084-b430-c7362698a137" variableName="errorDescription"/>
			<flow-ref doc:name="global-prepare-error-response-sub-flow" doc:id="bca057df-f35c-4917-9511-4afb5efdef63" name="global-prepare-error-response-sub-flow"/>
		
</on-error-propagate>
		
		<on-error-propagate type="HTTP:INTERNAL_SERVER_ERROR" enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="7515e3d9-4fc9-4894-ae8b-f2ef54222531" >
			<set-variable value="#[500]" doc:name="Set HTTP Status - 500" doc:id="d5a90c0d-03ed-4311-82e3-bc9579ec2545" variableName="httpStatus" />
      <logger level="INFO" doc:name="Logger" doc:id="2acb9a39-dd45-4322-8b48-37ed7db09ca5" message="kom ik hier"/>
			<set-variable value="Upstream service unable to fulfil request." doc:name="Set Error Message" doc:id="ad24660e-135e-49c5-82ab-63d9e3e61640" variableName="errorMessage"/>
			<flow-ref doc:name="global-prepare-error-response-sub-flow" doc:id="195d7d5f-59a2-4414-92b8-0e8a9687723e" name="global-prepare-error-response-sub-flow"/>
		</on-error-propagate>
		<on-error-propagate type="HTTP:NOT_ACCEPTABLE" enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="bb878ceb-6365-42b7-b382-faa3644ea3e0" >
			<set-variable value="#[406]" doc:name="Set HTTP Status - 406" doc:id="9df6da12-8998-47af-9c02-27bb5571e0ff" variableName="httpStatus" />
      <flow-ref doc:name="global-prepare-error-response-sub-flow" doc:id="7d2b5f67-d707-40d0-8f00-7ce0172645d2" name="global-prepare-error-response-sub-flow"/>
		</on-error-propagate>
		<on-error-propagate type="HTTP:NOT_FOUND" enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="75de992a-f8f5-444d-9d5e-efc4b7511af8" >
			<set-variable value="#[404]" doc:name="Set HTTP Status - 404" doc:id="18a2a239-4a69-4237-a4f8-cdcefde9f59d" variableName="httpStatus" />
      <set-variable value="The server has not found anything matching the Request-URI" doc:name="Set Error Message" doc:id="19710fdd-42f8-4105-b946-fdaf572ca8b6" variableName="errorMessage"/>
			<flow-ref doc:name="global-prepare-error-response-sub-flow" doc:id="dc3c2082-4a43-4635-b414-3f1e8ca09ed3" name="global-prepare-error-response-sub-flow"/>
		</on-error-propagate>
		<on-error-propagate type="HTTP:TIMEOUT" enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="65eed957-d2ee-4e04-9bfb-7d0d6aba4044" >
			<set-variable value="#[504]" doc:name="Set HTTP Status - 504" doc:id="d7e1c0c2-c4fc-4c45-ae6e-c17532cd75ce" variableName="httpStatus" />
      			<flow-ref doc:name="global-prepare-error-response-sub-flow" doc:id="79c2a37c-2e2b-466b-9d16-a9cb4aa26f85" name="global-prepare-error-response-sub-flow"/>
		</on-error-propagate>
		<on-error-propagate type="HTTP:TOO_MANY_REQUESTS" enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="e66da100-a762-4b2c-804d-827057fb8052" >
			<set-variable value="#[429]" doc:name="Set HTTP Status - 429" doc:id="54ae16e5-69ba-4156-b92c-e655bdc547c9" variableName="httpStatus" />
      			<flow-ref doc:name="global-prepare-error-response-sub-flow" doc:id="2f5f1c1c-3341-46b8-a2f2-8d6b5c7e348d" name="global-prepare-error-response-sub-flow"/>
		</on-error-propagate>
		<on-error-propagate type="HTTP:UNAUTHORIZED" enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="d892ad47-221c-407a-84fe-4b6f488b7ce8" >
			<set-variable value="#[403]" doc:name="Set HTTP Status - 403" doc:id="30e073f7-2852-4ac5-b325-7c0a16f04e01" variableName="httpStatus" />
      			<flow-ref doc:name="global-prepare-error-response-sub-flow" doc:id="a956e7f2-4b1f-406e-abe9-a3b959e06fa5" name="global-prepare-error-response-sub-flow"/>
		</on-error-propagate>
		<on-error-propagate type="HTTP:UNSUPPORTED_MEDIA_TYPE" enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="4c7e8d3b-e225-4b4f-b903-816ddf2754f0" >
			<set-variable value="#[415]" doc:name="Set HTTP Status - 415" doc:id="a67e1d61-c0fa-44b5-99d0-39de06df45f6" variableName="httpStatus" />
      			<flow-ref doc:name="global-prepare-error-response-sub-flow" doc:id="bf13bce6-cd04-4bee-9ad6-7b5a65639fa5" name="global-prepare-error-response-sub-flow"/>
		</on-error-propagate>
		
		<!-- Streaming related exception -->
		
		<!-- Generic CONNECTIVITY Related Exception handling start. Order matters -->
		<on-error-propagate type="CONNECTIVITY" enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="79053d8b-677b-4f83-ba1a-d9ebb5b60a7c" >
			<set-variable value="#[503]" doc:name="Set HTTP Status - 503" doc:id="2e4c0ea1-1fb1-4de2-9fa3-2295032c45c0" variableName="httpStatus" />
      			<set-variable value="Service unavailable" doc:name="Set vErrorMessage" doc:id="a5fbc70a-95ab-4cfe-aa6f-7dc6f2439bf5" variableName="errorMessage"/>
			<set-variable value="The (upstream) service is temporarily not available " doc:name="Set vErrorDescription" doc:id="7c315a1f-3ca3-47d1-a109-fd9a85a8d0ad" variableName="errorDescription"/>
			<flow-ref doc:name="global-prepare-error-response-sub-flow" doc:id="31ead45f-359e-429d-8b9a-18497a1e0264" name="global-prepare-error-response-sub-flow"/>
		</on-error-propagate>
		<on-error-propagate type="TIMEOUT" enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="64a398e7-bdac-4012-9ff1-6fa657977e9f" >
			<set-variable value="#[504]" doc:name="Set HTTP Status - 504" doc:id="7cf60f6b-da1e-44e2-9013-3b246b8cb2a2" variableName="httpStatus" />
      			<flow-ref doc:name="global-prepare-error-response-sub-flow" doc:id="c811c630-4efa-4c95-9e2a-b72af7d61985" name="global-prepare-error-response-sub-flow"/>
		</on-error-propagate>
		<!-- Generic CONNECTIVITY Exception handling end -->
		<on-error-propagate type="SECURITY" enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="39b22f7a-bcd2-4c3c-a445-d36127aba302" >
			<set-variable value="#[401]" doc:name="Set HTTP Status - 401" doc:id="363feb2c-f740-43bc-ba6e-53d683ceb60f" variableName="httpStatus" />
      			<flow-ref doc:name="global-prepare-error-response-sub-flow" doc:id="511aa802-20d8-43a9-a32f-8811ed599aa7" name="global-prepare-error-response-sub-flow"/>
		</on-error-propagate>
		<!-- If none of the above matches then handle a the exception using generic handler -->
		<on-error-propagate type="ANY" enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="a04e84a6-c879-4792-b6d8-2ec6dc78d336">
			<set-variable value="#[500]" doc:name="Set HTTP Status - 500" variableName="httpStatus"/>
			<set-variable value="Internal server error" doc:name="Set Error Message" doc:id="3101a183-12c6-4d7d-8d15-162e0abe895c" variableName="errorMessage"/>
			<set-variable value="The server encountered an unexpected condition which prevented it from fulfilling the request" doc:name="errorDescription" doc:id="c891fddd-e20a-49a9-81be-edeb2ac4114f" variableName="errorDescription"/>
			<flow-ref doc:name="global-prepare-error-response-sub-flow" doc:id="9485512e-253d-40cb-bc50-399bf759f78f" name="global-prepare-error-response-sub-flow"/>
		</on-error-propagate>
		<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="3df66021-72dc-41de-aabc-aabea6037c97" type="VALIDATION:NULL">
			<set-variable value="#[500]" doc:name="validation null-500" doc:id="28c97da2-9793-4f96-ac88-38ff4a066d29" variableName="validationNull"/>
			<flow-ref doc:name="global-prepare-error-response-sub-flow" doc:id="75394838-b999-4ffb-a9a8-477416881df3" name="global-prepare-error-response-sub-flow"/>
		</on-error-continue>
</error-handler>

    <sub-flow name="global-prepare-error-response-sub-flow" doc:id="294bf61e-2ea8-42a7-bb53-f43f7cf2460c">
		<ee:transform doc:name="Init Variables" doc:id="68da9a8e-2f36-4c0d-a9f3-d9c883892f4d" >
			<ee:message>
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="errorRaised"><![CDATA[%dw 2.0
output application/java
---
true]]></ee:set-variable>
				<ee:set-variable variableName="errorDescription"><![CDATA[%dw 2.0
output application/java
---
if(vars.errorDescription?) 
	vars.errorDescription 
else 
	error.exception.detailMessage]]></ee:set-variable>
				<ee:set-variable variableName="logCategory"><![CDATA[%dw 2.0
output application/java
---
'Exception']]></ee:set-variable>
				<ee:set-variable variableName="logLevel"><![CDATA[%dw 2.0
output application/java
---
'ERROR']]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<ee:transform doc:name="Error Response" doc:id="93aeba75-99b3-426b-8d69-9fe7b2846ec7" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json encoding="UTF-8", skipNullOn="everywhere"
var errors = (((error.description default "" replace "Error validating JSON. Error: - " with "") replace "- " with "") splitBy "\n")
---
{
	code : vars.httpStatus,
	message : if(vars.errorMessage != null) vars.errorMessage else (error.errorType.identifier),
	description: if(vars.errorDescription != null) vars.errorDescription else error.description,
	dateTime : now() as String { format: "yyyy-MM-dd'T'HH:mm:ss'Z'" },
	
}
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Error Log" doc:id="0588d281-7265-4cfe-9efe-d6dd5072867f" message="Transaction [#[vars.transactionId]] - Error Code [#[vars.httpStatus]] - Error Message [#[error.errorType.identifier default '']] - Error Description [#[error.description default '']]"/>
	</sub-flow>
</mule>
	

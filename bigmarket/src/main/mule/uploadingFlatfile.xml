<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:db="http://www.mulesoft.org/schema/mule/db" xmlns:tracing="http://www.mulesoft.org/schema/mule/tracing"
	xmlns:file="http://www.mulesoft.org/schema/mule/file"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/file http://www.mulesoft.org/schema/mule/file/current/mule-file.xsd
http://www.mulesoft.org/schema/mule/tracing http://www.mulesoft.org/schema/mule/tracing/current/mule-tracing.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd">
	<db:config name="Database_Config" doc:name="Database Config" doc:id="f75caea9-c4a3-4845-a69c-ec2b7cb977a4" >
		<db:generic-connection url="jdbc:postgresql://localhost:5432/postgres" driverClassName="org.postgresql.Driver" user="postgres" password="Balaji@123" />
	</db:config>
	<sub-flow name="uploadingFlatfile" doc:id="20b91975-32aa-4704-be9d-967a61c92859" >
		<ee:transform doc:name="Transform Message" doc:id="25fde792-fca6-48c0-a896-3b98562e132c">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output multipart/form-data
input payload multipart/form-data
---
payload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<flow-ref doc:name="Flow Reference" doc:id="d60ad45a-cfe8-4145-8be4-7a9dd4b6f5d9" name="addingStatus"/>
		<logger level="INFO" doc:name="Logger" doc:id="491761fe-1b9a-4750-9bad-a4f986fa479c" message="#[payload]"/>
		<flow-ref doc:name="Flow Reference" doc:id="e7c7fd05-6f81-44f6-87c6-1ac3d1f881c0" name="ASODM"/>
		<flow-ref doc:name="Flow Reference" doc:id="4e59d215-4916-42b4-8e55-828a35a2223d" name="transform1"/>
		<flow-ref doc:name="Flow Reference" doc:id="c7417866-88f0-4ff9-96f4-30eb0a3ff01d" name="transform2" />
		<flow-ref doc:name="Flow Reference" doc:id="657d61fe-20ac-4582-b675-98ce8efa0c9f" name="exporting" />
	</sub-flow>
	<sub-flow name="addingStatus" doc:id="3bb11feb-af39-4c43-834f-6008f02d6131" >
		<set-variable value="#[payload]" doc:name="Set Variable" doc:id="5f38940b-9a38-4998-b9be-1219755cce65" variableName="string" mimeType="application/json"/>
		<set-variable value="#[correlationId]" doc:name="With CorrelationID" doc:id="e9bfb77d-b07a-48a1-ac8b-c46aa443e351" variableName="coorrid"/>
		<db:delete doc:id="f95997fd-1447-4215-b079-4a959e9e3ed7" config-ref="Database_Config">
			<db:sql ><![CDATA[DELETE FROM event_management;]]></db:sql>
		</db:delete>
		<db:insert doc:name="Insert" doc:id="28970c53-2088-45a7-9484-15ec18fcdac5" config-ref="Database_Config">
			<db:sql ><![CDATA[insert into event_management(correlationid, status)
values(:corrid, 'File Imported')]]></db:sql>
			<db:input-parameters ><![CDATA[#[{corrid:vars.corrid}]]]></db:input-parameters>
		</db:insert>
		<set-payload value="#[vars.string]" doc:name="Set Payload" doc:id="099593c3-d315-4624-b6fa-a4aef096ab26" />
		<set-payload value="#[vars.corrid]" doc:name="Set Payload" doc:id="94b71339-ef2a-48b4-b383-719ec54589f1" />
		<ee:transform doc:name="Transform Message" doc:id="8084b1c8-5aa9-4d78-bed0-20e7bf497762" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload replace "\r" with ("")]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</sub-flow>
	<sub-flow name="ASODM" doc:id="e3000343-6511-427a-99d9-f04b10ee8316" >
		<ee:transform doc:name="Transform Message" doc:id="fc6ba56d-0f07-40e9-8aeb-289388db00c3" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload replace "02,USD,/" with ("02,USD,03/")]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</sub-flow>
	<sub-flow name="transform1" doc:id="e3ece584-1dc6-4272-8902-afcee5eade80" >
		<choice doc:name="Choice" doc:id="5c914c35-5493-49c1-aa5d-6b2891079a3c" >
			<when expression='#[payload contains("16,357,10000,,,00000201934/16,395,10000,,,00000201934/")]'>
				<ee:transform doc:name="Transform Message" doc:id="39c8868c-5c07-43a8-93bb-1a150700924e" >
					<ee:message >
						<ee:set-payload ><![CDATA[output text/plain
---
payload replace "16,357,10000,,,00000201934/16,395,10000,,,00000201934/" 
with ("16,357,10000,,,00000201934/")]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<flow-ref doc:name="Flow Reference" doc:id="913b1364-85d9-4615-be13-a38ee8dc9618" name="transform1"/>
			</when>
		</choice>
	</sub-flow>
	<sub-flow name="transform2" doc:id="17db20e5-ff45-48f6-8252-941a3ae8e1d4" >
		<choice doc:name="Choice" doc:id="d7e11d1b-3474-4634-b165-df6e66121068" >
			<when expression='#[payload contains("16,631,10000,,,00000201934/16,981,10000,,,00000201934/")]'>
				<ee:transform doc:name="Transform Message" doc:id="cb1e033b-70c9-42f8-863e-748305178675" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload replace "16,631,10000,,,00000201934/16,981,10000,,,00000201934/" with ("16,631,10000,,,00000201934/")]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<flow-ref doc:name="Flow Reference" doc:id="d8d8a43b-7ea8-4887-a989-da4eea1e6d9e" name="transform2"/>
			</when>
		</choice>
	</sub-flow>
	<sub-flow name="exporting" doc:id="3a8c7dac-63d5-4009-9b66-ceb834cd031c" >
		<set-variable value="#[correlationId]" doc:name="Set Variable" doc:id="45b72d01-c39b-4b91-b2d4-f59c11e54cb7" variableName="corrid" mimeType="application/json"/>
		<db:insert doc:name="Insert" doc:id="86c130c0-e29c-4274-b1e3-0e771e597eb8" config-ref="Database_Config">
			<db:sql ><![CDATA[insert into table event_management(correlationid, status)
values(:corrid, 'File Transformed')]]></db:sql>
			<db:input-parameters ><![CDATA[#[{corrid:vars.corrid}]]]></db:input-parameters>
		</db:insert>
		<set-payload value="#[vars.corrid]" doc:name="Set Payload" doc:id="c0e045ab-6818-4a02-b836-1e49e7667352" />
		<ee:transform doc:name="Transform Message" doc:id="9380e92e-a5a0-481c-9f9e-7ce9c7cbea51" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload replace "/" with ("/\n")]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<file:write doc:name="Write" doc:id="4c37a92a-cb3c-4fd3-82d5-c9d1228f712d" path="C:\Users\bpandhawale\Desktop\Extra\Practice\Write-file\out_putfile.txt"/>
		<db:insert doc:name="Insert" doc:id="1cbf0d7b-c416-4071-8ee8-a40d17c48d99" config-ref="Database_Config">
			<db:sql ><![CDATA[insert into table event_management(correlationid, status)
values(:corrid, 'File exported')]]></db:sql>
		</db:insert>
	</sub-flow>
</mule>
